// PRIMER REQUERIMIENTO DE CONSULTA
ALTER TABLE BODEGA ADD CAPACIDAD NUMBER NOT NULL; 

SELECT  
    B.NOMBRE AS nombre_bodega, 
    SUM(P.VOLUMEN_EMPAQUE * P.CANTIDAD_PRESENTACION) AS volumen_ocupado, 
    B.CAPACIDAD AS capacidad_total, 
    CASE  
        WHEN B.CAPACIDAD > 0 THEN ROUND((SUM(P.VOLUMEN_EMPAQUE * P.CANTIDAD_PRESENTACION) / B.CAPACIDAD) * 100, 2) 
        ELSE 0 
    END AS indice_ocupacion 
FROM BODEGA B 
LEFT JOIN PRODUCTO P ON P.CATEGORIA_ID = B.ID   
WHERE B.ID IN (SELECT SUCURSAL_ID FROM SUCURSAL WHERE ID = :idSucursal) 
GROUP BY B.NOMBRE, B.CAPACIDAD 
ORDER BY B.NOMBRE; 


--SEGUNDO REQUERIMIENTO DE CONSULTA
SELECT 
    P.ID AS producto_id,
    P.NOMBRE AS nombre_producto,
    P.COSTO_BODEGA AS costo_bodega,
    P.PRECIO_UNITARIO AS precio_unitario,
    P.PRESENTACION AS presentacion,
    P.CANTIDAD_PRESENTACION AS cantidad_presentacion,
    P.UNIDAD_MEDIDA AS unidad_medida,
    P.VOLUMEN_EMPAQUE AS volumen_empaque,
    P.PESO_EMPAQUE AS peso_empaque,
    P.FECHA_EXPIRACION AS fecha_expiracion,
    P.CODIGO_BARRAS AS codigo_barras,
    C.NOMBRE AS nombre_categoria
FROM PRODUCTO P
JOIN CATEGORIA_PRODUCTO C ON P.CATEGORIA_ID = C.ID
WHERE P.PRECIO_UNITARIO BETWEEN :precioMinimo AND :precioMaximo
    AND P.FECHA_EXPIRACION > :fechaVencimiento 
    AND P.ID IN (SELECT P2.ID FROM SUCURSAL S JOIN BODEGA B ON S.ID = B.ID JOIN PRODUCTO P2 ON B.ID = P2.ID 
        WHERE S.ID = :idSucursal)
    AND C.ID = :idCategoria;



--TERCER REQUERIMIENTO DE CONSULTA

ALTER TABLE BODEGA ADD (CANTIDAD_MINIMA NUMBER, COSTO_PROMEDIO NUMBER);

CREATE TABLE INVENTARIO (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    BODEGA_ID NUMBER,
    PRODUCTO_ID NUMBER,
    CANTIDAD_ACTUAL NUMBER,
    CONSTRAINT FK_BODEGA FOREIGN KEY (BODEGA_ID) REFERENCES BODEGA(ID),
    CONSTRAINT FK_PRODUCTO FOREIGN KEY (PRODUCTO_ID) REFERENCES PRODUCTO(ID)
);

SELECT 
    P.ID AS producto_id,
    P.NOMBRE AS nombre_producto,
    I.CANTIDAD_ACTUAL AS cantidad_actual,
    B.CANTIDAD_MINIMA AS cantidad_minima,
    B.COSTO_PROMEDIO AS costo_promedio
FROM INVENTARIO I JOIN PRODUCTO P ON I.PRODUCTO_ID = P.ID
JOIN BODEGA B ON I.BODEGA_ID = B.ID
JOIN SUCURSAL S ON B.ID = S.ID
WHERE S.ID = :sucursalId AND B.ID = :bodegaId;


-- CUARTO REQUERIMIENTO DE CONSULTA
 
SELECT s.* 
FROM Sucursal s 
JOIN Bodega b ON s.id = b.sucursal_id 
JOIN Producto p ON b.id = p.bodega_id 
WHERE p.id = :productoId 
  AND p.cantidad_actual > 0;  

-- QUINTO REQUERIMIENTO DE CONSULTA

SELECT P.ID AS producto_id,
    P.NOMBRE AS nombre_producto,
    B.NOMBRE AS bodega,
    S.NOMBRE AS sucursal,
    PR.NOMBRE AS proveedor,
SUM(O.CANTIDAD_PRODUCTO) AS cantidad_actual
FROM ORDEN_DE_COMPRA O
JOIN PRODUCTO P ON O.PRODUCTO_ID = P.ID
JOIN SUCURSAL S ON O.SUCURSAL_ID = S.ID
JOIN BODEGA B ON S.ID = B.ID 
JOIN PROVEEDOR PR ON O.PROVEEDOR_NIT = PR.NIT
WHERE SUM(O.CANTIDAD_PRODUCTO) < (SELECT valor_minimo FROM BODEGA_CONFIG BC WHERE BC.PRODUCTO_ID = P.ID AND BC.BODEGA_ID = B.ID)
GROUP BY P.ID, P.NOMBRE, B.NOMBRE, S.NOMBRE, PR.NOMBRE
HAVING SUM(O.CANTIDAD_PRODUCTO) < (SELECT valor_minimo FROM BODEGA_CONFIG BC WHERE BC.PRODUCTO_ID = P.ID AND BC.BODEGA_ID = B.ID);
